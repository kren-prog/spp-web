<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <title>ActiveGanttJQW - Simple Scheduling Example that handles ObjectAdded and CompleteObjectChange events</title>
    <script src="../Scripts/jquery-2.0.3.js" type="text/javascript"></script>
    <script src="../Scripts/jquery.ui.widget.js" type="text/javascript"></script>
    <script src="../Scripts/AGJQW.js" type="text/javascript"></script>
    <link href="../CSS/Toolbar.css" rel="stylesheet" type="text/css" />

    <style>
        #divStatus {
            font-family: Segoe, Segoe UI, Arial, Helvetica, Sans-Serif;
            background-color: #27bffb;
            height: 20px;
        }
    </style>
</head>

<body>

    <div class="Toolbar">
        <input type="image" src="../Images/Toolbars/back2.png" alt="" onclick="cmdBack2_Click();">
        <input type="image" src="../Images/Toolbars/back1.png" alt="" onclick="cmdBack1_Click();">
        <input type="image" src="../Images/Toolbars/back0.png" alt="" onclick="cmdBack0_Click();">
        <input type="image" src="../Images/Toolbars/fwd0.png" alt="" onclick="cmdFwd0_Click();">
        <input type="image" src="../Images/Toolbars/fwd1.png" alt="" onclick="cmdFwd1_Click();">
        <input type="image" src="../Images/Toolbars/fwd2.png" alt="" onclick="cmdFwd2_Click();">
    </div>
    <div class="row">
        <!-- <div class="col-2">
            <table class="table table-sm table-info m-2">
                <thead>
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">Ordenes de fabricación</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <th scope="row">1</th>
                         <td><input class="btn btn-primary" type="button" value="23" draggable="true" id="caja"></td> 
                    </tr>
                    <tr>
                        <th scope="row">2</th>
                        <td><input class="btn btn-primary" type="button" value="48" draggable="true" id="caja1"></td>
                    </tr>
                    <tr>
                        <th scope="row">3</th>
                        <td><input class="btn btn-primary" type="button" value="15" draggable="true"></td>
                    </tr>
                </tbody>
            </table>

            <div id="contenedor1" class="mx-2 mt-5 w-100 h-50 border border-primary">
                <h4 class=""> Contenedor</h4>
            </div>

        </div> -->
        <div class="col-1">
            <input class="btn btn-primary" type="button" value="23" draggable="true" id="caja">
        </div>
       
        <div class="col-11">

            <div id="contenedor">

                <div id="oActiveGantt" style="width: 80%; height: 100%; ">
                </div>
            </div>
            <div id="divStatus" class="m-auto"></div>
        </div>
      

    </div>
    <script>

        var ActiveGanttJQWCtl1;
        var mp_dtStartDate = new AGJQW.DateTime();

        $(document).ready(function () {

            $('#oActiveGantt').ActiveGanttJQWCtl();
            ActiveGanttJQWCtl1 = $('#oActiveGantt').ActiveGanttJQWCtl("GetControl");
            $('#oActiveGantt').ActiveGanttJQWCtl("option", "ObjectAdded_callback", ActiveGanttJQWCtl_ObjectAdded);
            $('#oActiveGantt').ActiveGanttJQWCtl("option", "CompleteObjectChange_callback", ActiveGanttJQWCtl_CompleteObjectChange);

            ActiveGanttJQWCtl1.ApplyTemplate(AGJQW.E_CONTROLTEMPLATE.STC_CH_VGRAD_BLUE_VIOLET, AGJQW.E_OBJECTTEMPLATE.STO_COLOR_HATCH);

            oStyle = ActiveGanttJQWCtl1.Styles.Add("SelectedPredecessor");
            oStyle.PredecessorStyle.LineColor = AGJQW.Color_FromArgb(255, 0, 128, 0);

            ActiveGanttJQWCtl1.AllowRowMove = true;
            ActiveGanttJQWCtl1.AllowRowSize = true;
            ActiveGanttJQWCtl1.AddMode = AGJQW.E_ADDMODE.AT_BOTH;
            /** Text, Key, Width, StyleIndex*/
            ActiveGanttJQWCtl1.Columns.Add("Procesos", "", 150, "");
            ActiveGanttJQWCtl1.Columns.Add("Máquina", "", 100, "");
            /** Columna en la que se ubica la  jerarquia de procesos */
            ActiveGanttJQWCtl1.TreeviewColumnIndex = 1;

            ActiveGanttJQWCtl1.Treeview.Images = true;
            ActiveGanttJQWCtl1.Treeview.CheckBoxes = true;
            ActiveGanttJQWCtl1.Treeview.TreeviewMode = AGJQW.E_TREEVIEWMODE.TM_EXPANDCOLLAPSEICONS;
            ActiveGanttJQWCtl1.Treeview.TreeLines = false;
            ActiveGanttJQWCtl1.Splitter.Position = 255;

            let idxP = 1;
            let idxS = 1;


            for (i = 1; i <= 10; i++) {
                var oRow = null;

                // oRow = ActiveGanttJQWCtl1.Rows.Add("K" + i, "Proceso " + idxP, true, true, "");

                if (i % 2 == 0) {
                    for (let j = 1; j < 4; j++) {
                        if (j == 2) {
                            oRow = ActiveGanttJQWCtl1.Rows.Add("L" + idxS, "Sub-subproceso " + idxS);
                            oRow.Cells.Item("2").Text = "subMáquina " + idxS;
                            oRow.Node.Depth = 2;
                        } else {
                            oRow = ActiveGanttJQWCtl1.Rows.Add("J" + idxS, "Subproceso " + idxS);
                            oRow.Cells.Item("2").Text = "Máquina " + idxS;
                            oRow.Node.Depth = 1;
                        }
                        idxS++;
                    }
                } else {
                    oRow = ActiveGanttJQWCtl1.Rows.Add("K" + i, "Proceso " + idxP);
                    oRow.Cells.Item("2").Text = "";

                    idxP++;
                }
            }
            /** La sgte linea permite que se puedan desplegar u ocultar los subitems */
            ActiveGanttJQWCtl1.Rows.UpdateTree();
            window.addEventListener('resize', mp_WindowResize, true);

            mp_WindowResize();

        });

        /** Adapta el tamaño del gantt a la pantalla */
        function mp_WindowResize() {
            $('#oActiveGantt').height(window.innerHeight - 80);
            $('#oActiveGantt').ActiveGanttJQWCtl("Resize");
        }

        /**Añadir objetos al Gantt */
        function ActiveGanttJQWCtl_ObjectAdded(sender, e) {
            var sObjectType = "";
            switch (e.EventTarget) {
                case AGJQW.E_EVENTTARGET.EVT_TASK:
                    sObjectType = "Task";
                    break;
                case AGJQW.E_EVENTTARGET.EVT_MILESTONE:
                    sObjectType = "Milestone";
                    break;
            }
            $("#divStatus").html("ObjectAdded ObjectType: " + sObjectType + ", ObjectIndex: " + e.TaskIndex + " event " + e.EventTarget);
        }
        /** Mover o cambiar tamaño de los objetos */
        function ActiveGanttJQWCtl_CompleteObjectChange(sender, e) {
            var sObjectType = "";
            switch (e.EventTarget) {
                case AGJQW.E_EVENTTARGET.EVT_TASK:
                    sObjectType = "Task";
                    break;
                case AGJQW.E_EVENTTARGET.EVT_MILESTONE:
                    sObjectType = "Milestone";
                    break;
            }
            var sChangeType = "";
            switch (e.ChangeType) {
                case AGJQW.E_CHANGETYPE.CT_MOVE:
                    sChangeType = "Object has been moved."
                    break;
                case AGJQW.E_CHANGETYPE.CT_SIZE:
                    sChangeType = "Object has been resized."
                    break;
            }
            $("#divStatus").html("CompleteObjectChange ObjectType: " + sObjectType + ", ObjectIndex: " + e.Index + ", " + sChangeType + " event " + e.EventTarget);
        }

        /** FUNCIONES PARA LOS BOTONES DE TOOLBAR */
        function cmdBack2_Click() {
            ActiveGanttJQWCtl1.CurrentViewObject.TimeLine.Position(ActiveGanttJQWCtl1.MathLib.DateTimeAdd(AGJQW.E_INTERVAL.IL_HOUR, -24 * 7, ActiveGanttJQWCtl1.CurrentViewObject.TimeLine.StartDate));
            ActiveGanttJQWCtl1.Redraw();
        }

        function cmdBack1_Click() {
            ActiveGanttJQWCtl1.CurrentViewObject.TimeLine.Position(ActiveGanttJQWCtl1.MathLib.DateTimeAdd(AGJQW.E_INTERVAL.IL_HOUR, -24, ActiveGanttJQWCtl1.CurrentViewObject.TimeLine.StartDate));
            ActiveGanttJQWCtl1.Redraw();
        }

        function cmdBack0_Click() {
            ActiveGanttJQWCtl1.CurrentViewObject.TimeLine.Position(ActiveGanttJQWCtl1.MathLib.DateTimeAdd(AGJQW.E_INTERVAL.IL_HOUR, -1, ActiveGanttJQWCtl1.CurrentViewObject.TimeLine.StartDate));
            ActiveGanttJQWCtl1.Redraw();
        }

        function cmdFwd0_Click() {
            ActiveGanttJQWCtl1.CurrentViewObject.TimeLine.Position(ActiveGanttJQWCtl1.MathLib.DateTimeAdd(AGJQW.E_INTERVAL.IL_HOUR, 1, ActiveGanttJQWCtl1.CurrentViewObject.TimeLine.StartDate));
            ActiveGanttJQWCtl1.Redraw();
        }

        function cmdFwd1_Click() {
            ActiveGanttJQWCtl1.CurrentViewObject.TimeLine.Position(ActiveGanttJQWCtl1.MathLib.DateTimeAdd(AGJQW.E_INTERVAL.IL_HOUR, 24, ActiveGanttJQWCtl1.CurrentViewObject.TimeLine.StartDate));
            ActiveGanttJQWCtl1.Redraw();
        }

        function cmdFwd2_Click() {
            ActiveGanttJQWCtl1.CurrentViewObject.TimeLine.Position(ActiveGanttJQWCtl1.MathLib.DateTimeAdd(AGJQW.E_INTERVAL.IL_HOUR, 24 * 7, ActiveGanttJQWCtl1.CurrentViewObject.TimeLine.StartDate));
            ActiveGanttJQWCtl1.Redraw();
        }
        const gantt = document.querySelector('#contenedor');
        //drop
        gantt.addEventListener("dragover", function (event) {
            let otask = null;
            // offset para obtener las coordenadas del mouse relativas al elemento div
            // client para obtener las coordenadas relativas a la ventana del navegador 
            var x = event.offsetX;
            var y = event.offsetY;
            // Acá se obtiene la fila sobre la que esta el mouse a partir de la coordenada Y 
            // al parecer tiene en cuenta la cabecera de la tabla como primera fila
            var pixelData = ActiveGanttJQWCtl1.MathLib.GetRowIndexByPosition(y);
            // Se obtiene un objeto Datetime a partir de la coordenada X
            var dragDate = ActiveGanttJQWCtl1.MathLib.GetDateFromXCoordinate(x);
            var dtEndDate = new AGJQW.DateTime(2023, 6, 6, 12, 0, 0);
            // Obtiene el objeto fila sobre el que esta el mouse
            //var rowKey = ActiveGanttJQWCtl1.Rows.Item(pixelData-1);
            //console.log(rowKey);
            // oTask = ActiveGanttJQWCtl1.Tasks.Add("Ensayo", rowKey.mp_sKey, dragDate, dtEndDate, "T" + 6, "", "");
            // ActiveGanttJQWCtl1.Rows.UpdateTree();
            // ActiveGanttJQWCtl1.Redraw();

            console.log("Fila: " + pixelData + " Fecha: " + dragDate.Day() + '-' + dragDate.Month() + '-' + dragDate.Year() + " " + dragDate.Hour() + " " + dragDate.Minute());

        });
    </script>

    <script>
        const caja = document.querySelector('#caja');
        //const caja1 = document.querySelector('#caja1');
        let drag = null;
        const contenedor = document.querySelector('#contenedor');

        caja.addEventListener('drag', e => {
            console.log('Drag');
            drag = caja;
        });
        // caja1.addEventListener('drag', e => {
        //     console.log('Drag');
        //     drag = caja1;
        // });

        contenedor.addEventListener('dragenter', e => {
            console.log('Drag enter');
        });

        contenedor.addEventListener('dragover', e => {
            e.preventDefault();
            console.log('Drag over');
        });

        contenedor.addEventListener('drop', e => {
            console.log('Drop');
            contenedor.appendChild(drag);
        });




    </script>

</body>

</html>